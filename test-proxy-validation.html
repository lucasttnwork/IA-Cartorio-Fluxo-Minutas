<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste de Valida√ß√£o de Procura√ß√£o</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .document-card {
      border: 2px solid #e5e5e5;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .document-card:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      margin: 4px;
    }
    .badge-valid {
      background: #dcfce7;
      color: #16a34a;
      border: 1px solid #86efac;
    }
    .badge-warning {
      background: #fef3c7;
      color: #ca8a04;
      border: 1px solid #fde047;
    }
    .badge-error {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }
    .validation-details {
      margin-top: 10px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 4px;
      font-size: 14px;
    }
    .validation-details ul {
      margin: 5px 0;
      padding-left: 20px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <h1>üîç Teste de Valida√ß√£o de Procura√ß√£o</h1>

  <div class="test-section">
    <h2>Cen√°rios de Teste</h2>
    <p>Esta p√°gina demonstra a funcionalidade de valida√ß√£o de procura√ß√µes implementada no sistema.</p>
    <button onclick="runTests()">Executar Testes de Valida√ß√£o</button>
  </div>

  <div id="results" class="test-section" style="display: none;">
    <h2>Resultados dos Testes</h2>
    <div id="test-results"></div>
  </div>

  <script>
    // Proxy validation logic (adapted from proxyValidation.ts)
    const REQUIRED_REAL_ESTATE_POWERS = [
      'vender',
      'comprar',
      'alienar',
      'transacionar',
      'negociar',
    ];

    function validateProxyDocument(document) {
      const errors = [];
      const warnings = [];

      if (document.doc_type !== 'proxy') {
        return { isValid: true, errors: [], warnings: [] };
      }

      const metadata = document.metadata;

      // Check expiration date
      if (metadata.proxy_expiration_date) {
        const expirationDate = new Date(metadata.proxy_expiration_date);
        const now = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(now.getDate() + 30);

        if (expirationDate < now) {
          errors.push({
            code: 'EXPIRED',
            message: `Procura√ß√£o expirada em ${expirationDate.toLocaleDateString('pt-BR')}`,
          });
        } else if (expirationDate < thirtyDaysFromNow) {
          warnings.push({
            code: 'EXPIRING_SOON',
            message: `Procura√ß√£o expira em ${expirationDate.toLocaleDateString('pt-BR')} (menos de 30 dias)`,
          });
        }
      }

      // Check for required powers
      if (metadata.proxy_powers && Array.isArray(metadata.proxy_powers)) {
        const hasRequiredPower = REQUIRED_REAL_ESTATE_POWERS.some((requiredPower) =>
          metadata.proxy_powers.some((power) =>
            typeof power === 'string' && power.toLowerCase().includes(requiredPower)
          )
        );

        if (!hasRequiredPower) {
          errors.push({
            code: 'MISSING_POWERS',
            message: 'Procura√ß√£o n√£o cont√©m poderes espec√≠ficos para transa√ß√µes imobili√°rias',
          });
        }
      } else {
        warnings.push({
          code: 'MISSING_POWERS',
          message: 'Poderes da procura√ß√£o n√£o foram extra√≠dos',
        });
      }

      // Check for signatories
      if (!metadata.proxy_signatories || !Array.isArray(metadata.proxy_signatories) || metadata.proxy_signatories.length === 0) {
        errors.push({
          code: 'MISSING_SIGNATORIES',
          message: 'Procura√ß√£o n√£o possui assinaturas identificadas',
        });
      }

      // Check for grantor
      if (!metadata.proxy_grantor || typeof metadata.proxy_grantor !== 'string' || metadata.proxy_grantor.trim() === '') {
        errors.push({
          code: 'MISSING_GRANTOR',
          message: 'Outorgante n√£o identificado',
        });
      }

      // Check for grantee
      if (!metadata.proxy_grantee || typeof metadata.proxy_grantee !== 'string' || metadata.proxy_grantee.trim() === '') {
        errors.push({
          code: 'MISSING_GRANTEE',
          message: 'Outorgado n√£o identificado',
        });
      }

      // Warning for private proxy
      if (metadata.proxy_type === 'private') {
        warnings.push({
          code: 'PRIVATE_PROXY',
          message: 'Procura√ß√£o particular (menos formal)',
        });
      }

      // Warning if no notary info
      if (!metadata.proxy_notary_info) {
        warnings.push({
          code: 'MISSING_NOTARY',
          message: 'Informa√ß√µes do cart√≥rio n√£o identificadas',
        });
      }

      // Warning if document has low confidence
      if (document.doc_type_confidence && document.doc_type_confidence < 0.7) {
        warnings.push({
          code: 'LOW_CONFIDENCE',
          message: `Baixa confian√ßa na classifica√ß√£o (${Math.round(document.doc_type_confidence * 100)}%)`,
        });
      }

      const isValid = errors.length === 0;
      return { isValid, errors, warnings };
    }

    // Test scenarios
    const testDocuments = [
      {
        id: 'valid-proxy',
        name: 'Procura√ß√£o V√°lida Completa',
        doc_type: 'proxy',
        doc_type_confidence: 0.95,
        metadata: {
          proxy_expiration_date: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
          proxy_powers: ['vender', 'comprar', 'assinar', 'representar'],
          proxy_signatories: ['Jo√£o Silva', 'Maria Santos'],
          proxy_grantor: 'Jo√£o Silva',
          proxy_grantee: 'Maria Santos',
          proxy_notary_info: '1¬∫ Tabelionato de S√£o Paulo',
          proxy_type: 'public',
        },
      },
      {
        id: 'expired-proxy',
        name: 'Procura√ß√£o Expirada',
        doc_type: 'proxy',
        doc_type_confidence: 0.92,
        metadata: {
          proxy_expiration_date: new Date('2023-01-01').toISOString(),
          proxy_powers: ['vender', 'comprar'],
          proxy_signatories: ['Pedro Costa'],
          proxy_grantor: 'Pedro Costa',
          proxy_grantee: 'Ana Lima',
          proxy_type: 'public',
        },
      },
      {
        id: 'expiring-soon-proxy',
        name: 'Procura√ß√£o Expirando em Breve',
        doc_type: 'proxy',
        doc_type_confidence: 0.88,
        metadata: {
          proxy_expiration_date: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString(),
          proxy_powers: ['vender', 'alienar'],
          proxy_signatories: ['Carlos Mendes'],
          proxy_grantor: 'Carlos Mendes',
          proxy_grantee: 'Roberto Silva',
          proxy_type: 'public',
        },
      },
      {
        id: 'missing-powers-proxy',
        name: 'Procura√ß√£o sem Poderes Imobili√°rios',
        doc_type: 'proxy',
        doc_type_confidence: 0.90,
        metadata: {
          proxy_expiration_date: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString(),
          proxy_powers: ['assinar', 'representar', 'receber'],
          proxy_signatories: ['Lucia Fernandes'],
          proxy_grantor: 'Lucia Fernandes',
          proxy_grantee: 'Paulo Santos',
          proxy_type: 'public',
        },
      },
      {
        id: 'incomplete-proxy',
        name: 'Procura√ß√£o com Dados Incompletos',
        doc_type: 'proxy',
        doc_type_confidence: 0.65,
        metadata: {
          proxy_powers: ['vender'],
          proxy_type: 'private',
        },
      },
    ];

    function renderValidationBadge(validation) {
      if (!validation.isValid) {
        return '<span class="badge badge-error">‚ùå Inv√°lida</span>';
      }
      if (validation.warnings.length > 0) {
        return `<span class="badge badge-warning">‚ö†Ô∏è ${validation.warnings.length} Aviso(s)</span>`;
      }
      return '<span class="badge badge-valid">‚úÖ V√°lida</span>';
    }

    function runTests() {
      const resultsDiv = document.getElementById('test-results');
      const resultsSection = document.getElementById('results');

      resultsDiv.innerHTML = '';
      resultsSection.style.display = 'block';

      testDocuments.forEach(doc => {
        const validation = validateProxyDocument(doc);

        const card = document.createElement('div');
        card.className = 'document-card';

        let detailsHTML = '';
        if (validation.errors.length > 0) {
          detailsHTML += '<div class="validation-details"><strong>Erros:</strong><ul>';
          validation.errors.forEach(err => {
            detailsHTML += `<li><strong>${err.code}:</strong> ${err.message}</li>`;
          });
          detailsHTML += '</ul></div>';
        }

        if (validation.warnings.length > 0) {
          detailsHTML += '<div class="validation-details"><strong>Avisos:</strong><ul>';
          validation.warnings.forEach(warn => {
            detailsHTML += `<li><strong>${warn.code}:</strong> ${warn.message}</li>`;
          });
          detailsHTML += '</ul></div>';
        }

        if (validation.isValid && validation.warnings.length === 0) {
          detailsHTML = '<div class="validation-details" style="color: #16a34a;">‚úÖ Todos os crit√©rios de valida√ß√£o foram atendidos</div>';
        }

        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3 style="margin: 0 0 8px 0; color: #1f2937;">üìÑ ${doc.name}</h3>
              <div style="font-size: 13px; color: #6b7280;">ID: ${doc.id}</div>
              <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                Confian√ßa: ${Math.round((doc.doc_type_confidence || 0) * 100)}%
              </div>
            </div>
            <div>
              ${renderValidationBadge(validation)}
            </div>
          </div>
          ${detailsHTML}
        `;

        resultsDiv.appendChild(card);
      });

      // Scroll to results
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Run tests on page load
    window.addEventListener('load', () => {
      console.log('Proxy Validation Test Page Loaded');
    });
  </script>
</body>
</html>
